# 实现信号丢失检测和故障诊断机制

## 1. 方案概述

本方案将在KF-GINS系统中实现以下功能：

* IMU信号丢失检测

* 增强GNSS信号丢失处理（添加时间计数和显示）

* 故障诊断与报警机制

## 2. 具体实现

### 2.1 修改 `gi_engine.h` 文件

#### 2.1.1 添加常量定义

* 添加IMU超时阈值常量 `IMU_TIMEOUT_THRESHOLD`

* 添加GNSS超时阈值常量 `GNSS_TIMEOUT_THRESHOLD`

#### 2.1.2 添加枚举类型

* 添加故障类型枚举 `FaultType`

* 添加故障级别枚举 `FaultLevel`

#### 2.1.3 添加成员变量

* `imu_lost_`: IMU信号丢失标志

* `gnss_lost_`: GNSS信号丢失标志

* `gnss_last_valid_time_`: 最后一次有效GNSS时间

* `gnss_lost_time_`: GNSS信号丢失时长

* `last_imu_time_`: 上一次IMU数据时间

#### 2.1.4 添加成员函数

* `checkImuSignal()`: 检查IMU信号状态

* `checkGnssSignal()`: 检查GNSS信号状态

* `reportFault()`: 报告故障信息

* `getFaultStatus()`: 获取当前故障状态

### 2.2 修改 `gi_engine.cpp` 文件

#### 2.2.1 修改构造函数

* 初始化新增的成员变量

#### 2.2.2 修改 `addImuData()` 函数

* 添加IMU信号丢失检测逻辑

* 计算IMU数据时间差

* 超过阈值时触发故障报告

#### 2.2.3 修改 `addGnssData()` 函数

* 更新最后一次有效GNSS时间

* 重置GNSS信号丢失标志

#### 2.2.4 修改 `newImuProcess()` 函数

* 调用IMU和GNSS信号检查函数

* 更新GNSS信号丢失时长

* 根据需要触发故障报告

#### 2.2.5 实现新增的成员函数

* `checkImuSignal()`: 实现IMU信号检查逻辑

* `checkGnssSignal()`: 实现GNSS信号检查逻辑

* `reportFault()`: 实现故障报告逻辑

* `getFaultStatus()`: 实现获取故障状态逻辑

## 3. 实现细节

### 3.1 IMU信号丢失检测

* 在`addImuData()`函数中计算相邻IMU数据的时间差

* 如果时间差超过`IMU_TIMEOUT_THRESHOLD`（例如1秒），则触发IMU信号丢失报警

* 记录IMU信号丢失状态，并在后续数据恢复时清除

### 3.2 GNSS信号丢失处理

* 在`addGnssData()`函数中更新`gnss_last_valid_time_`

* 在`newImuProcess()`函数中计算当前时间与`gnss_last_valid_time_`的差值

* 如果差值超过`GNSS_TIMEOUT_THRESHOLD`（例如5秒），则触发GNSS信号丢失报警

* 更新`gnss_lost_time_`，并在终端显示丢失时长

### 3.3 故障诊断与报警机制

* 实现多级故障报警（警告、严重、致命）

* 根据故障类型和级别输出不同格式的报警信息

* 在关键处理步骤中调用故障检测函数

* 提供获取当前故障状态的接口

## 4. 预期效果

* 当IMU信号丢失时，系统会输出报警信息：`IMU signal lost at [timestamp]!`

* 当GNSS信号丢失时，系统会输出报警信息：`GNSS signal lost at [timestamp]! Lost time: [duration]s`

* 系统会根据故障级别输出不同严重程度的报警信息

* 用户可以通过`getFaultStatus()`接口获取当前系统状态

## 5. 文件修改列表

* `d:\GPS-Seeder\KF-GINS\src\kf-gins\gi_engine.h`

* `d:\GPS-Seeder\KF-GINS\src\kf-gins\gi_engine.cpp`

